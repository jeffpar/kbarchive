<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/kbarchive/assets/css/style.css?v=231b77c990cb1dad78d33119176ff1f53331eb63">
    <link rel="stylesheet" type="text/css" href="/kbarchive/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Q129787: HOWTO: Build a Code Resource | KnowledgeBase Archive</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="Q129787: HOWTO: Build a Code Resource" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<meta property="og:description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<link rel="canonical" href="http://jeffpar.github.io/kbarchive/kb/129/Q129787/" />
<meta property="og:url" content="http://jeffpar.github.io/kbarchive/kb/129/Q129787/" />
<meta property="og:site_name" content="KnowledgeBase Archive" />
<script type="application/ld+json">
{"description":"An Archive of Early Microsoft KnowledgeBase Articles","@type":"WebPage","url":"http://jeffpar.github.io/kbarchive/kb/129/Q129787/","headline":"Q129787: HOWTO: Build a Code Resource","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
<div id="container">
    <div class="inner">

        <header>
            <h1><a href="/kbarchive">KnowledgeBase Archive</a></h1>
            <h2>An Archive of Early Microsoft KnowledgeBase Articles</h2>
        </header>
        <section id="downloads" class="clearfix">
            
            
            <a href="http://github.com/jeffpar/kbarchive" id="view-on-github" class="button"><span>View on GitHub</span></a>
            
        </section>
        <hr>
        <section id="main_content">
                <div>
        <h2 id="q129787-howto-build-a-code-resource">Q129787: HOWTO: Build a Code Resource</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Article: Q129787
Product(s): Microsoft C Compiler
Version(s): MAC:2.0;
Operating System(s): 
Keyword(s): kbcode kbHWMAC kbVC kbhowto
Last Modified: 23-JUL-2001

-------------------------------------------------------------------------------
The information in this article applies to:

- Microsoft Visual C++, Macintosh Cross-Development Addon, version 4.0 
-------------------------------------------------------------------------------

SUMMARY
=======

You can use Visual C++ to build Code Resources of type CDEF, cdev, INIT, LDEF,
MDEF, WDEF, and XCMD. This article illustrates how.

MORE INFORMATION
================

Applications use the register A5 to point to their global memory and as a base
for intersegment jumps. Stand-alone Code Resources cannot use A5 in this manner.
To use global memory in Visual C++, follow these steps:

1. Locate the entry points for the Code Resource types (CDEF, cdev, INIT, LDEF,
  MDEF, WDEF, and XCMD) at the beginning of the resource. When Visual C++
  compiles a code resource, it locates the global data at the beginning of the
  resource by default. To force the global data to be moved to the end of the
  resource use the code_seg pragma as in this example:

     #pragma code_seg("MAIN$2")

  This forces any declarations that follow to be placed in the second half of
  the MAIN Code Resource. The data is referenced as an offset from the PC
  register, rather than the A5 register.

2. To avoid an intersegment jump, merge the code from two segments together by
  using the Linker's MERGE option. This step is necessary if a Code Resource
  calls into a library such as the C Runtime libraries because a second segment
  is created and the call to the function becomes an intersegment jump.

  For example, if the C Runtime library is being merged with and INIT titled
  MAIN, add the following line to the Link:Project Options found in the Project
  Settings dialog:

  " MERGE:CRTSTRING?=MAIN " (without the quotation marks) Replace the question
  mark (?) with an ASCII character 1. The CRTSTRING? segment is titled CRTSTRIN
  by the Linker, so the name of the segments in the target application cannot
  be used. To determine the name of any segments generated by Visual C++, build
  the Code Resource as a 'CODE' resource first. Then check the .MAP file for
  the correct spelling of the segment.

  If a Code Resource is built without merging the segments the following Linker
  error is generated: error LNK1574: A5 reference to SomeFunction invalid in
  standalone code

Sample Code
-----------

Here is a sample INIT Code Resource including code and project settings:

The C/C++ Project Options:

  /nologo /W3 /YX /Oi /D "_WINDOWS" /D "_MAC" /D "_68K_" /D "NDEBUG" /D
  "_MBCS"
   /FR"MacRel/" /Fp"MacRel/CodRes.pch" /Fo"MacRel/" /c

The Link Project Options:

  libcs.lib /NOLOGO /MAC:bundle /MAC:type="rsrc" /MAC:creator="RSED"
   /PDB:"MacRel/CodRes.pdb" /MAP:"MacRel/SACODE.map" /DEBUG /MACHINE:M68K
   /NODEFAULTLIB:"swapd.lib" /NODEFAULTLIB /OUT:"MacRel/CODRES.exe"
  /entry:main
   /section:MAIN,,resource="INIT"@99 /MERGE:CRTSTRING =MAIN

The code for this sample:

     #include &lt;string.h&gt;
     #include &lt;macos\osutils.h&gt;
     #pragma code_seg("MAIN$2")
     char _declspec(allocate("_CODE")) java[10] =" Help Me!";
     #pragma code_seg("MAIN$1")
     void main(void)
        {
        char   bob[10];
        bob[0]=0;
        strcpy(bob,java);
        DebugStr(_c2pstr(bob));
        }

This code creates an INIT with a resource ID of 99. There will also be resources
of DATA, CODE, and MSCV. They are not needed for this Code Resource to function.

Additional query words:

======================================================================
Keywords          : kbcode kbHWMAC kbVC kbhowto 
Technology        : kbVCsearch kbHWMAC kbOSMAC kbAudDeveloper kbVCXDev400Mac
Version           : MAC:2.0;
Issue type        : kbhowto

=============================================================================
</code></pre></div></div>


        <p>
            THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
            PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
            ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
            OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
            EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
            ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
            CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
            MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
            POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
            OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
            SO THE FOREGOING LIMITATION MAY NOT APPLY.
        </p>
        <p>Copyright Microsoft Corporation 1986-2002.</p>
    </div>

        </section>

        <footer>
            
            KnowledgeBase Archive is maintained by <a href="https://www.pcjs.org">PCjs</a>.<br>
            
            This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

    </div>
</div>


</body>
</html>